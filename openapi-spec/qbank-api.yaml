openapi: 3.1.0
info:
  title: QBank Connect API
  description: |
    Provides third-party Treasury Management platforms with secure, real-time, and batch-latent 
    access to QBank's suite of financial services, including Cash Positioning, Payment Initiation, 
    Fraud Prevention, and Webhook status updates.
  version: v1
servers:
  # QBank Connect employs a URL-based versioning strategy (i.e. /v1/).
  - url: https://api.qbankconnect.com/v1
    description: Production Server

# Define required security for all endpoints
security:
  - qBankAuth:
      - accounts.read
      - balances.read
      - transactions.read
      - payments.read
      - payments.ach.write
      - payments.wire.write
      - transfers.write
      - positivepay.issues.write
      - positivepay.exceptions.read

paths:
  # === AUTHENTICATION ===
  /token:
    post:
      summary: Obtain an Access Token
      operationId: getAccessToken
      tags:
        - Authentication
      description: Exchanges credentials for a short-term Bearer Token via OAuth 2.0 Client Credentials Grant.
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/TokenRequest'
      responses:
        '200':
          description: Successfully obtained a Bearer Token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'

  # === ACCOUNT AND BALANCE READS ===
  /accounts:
    get:
      summary: Retrieve a list of accounts
      operationId: getAccounts
      tags:
        - Account
      description: |
        Retrieves general account information. This endpoint is **Batch-Latent (Daily)** due to the 
        backend mETL engine architecture.
      security:
        - qBankAuth: [accounts.read]
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Account'
        default:
          $ref: '#/components/responses/StandardError'

  /balances/{accountId}:
    get:
      summary: Get current cash balance for an account
      operationId: getAccountBalance
      tags:
        - Balance
      description: |
        Retrieves the most recent balance. This is a **Real-Time synchronous** call to the core system 
        for immediate cash positioning.
      parameters:
        - $ref: '#/components/parameters/accountId'
      security:
        - qBankAuth: [balances.read]
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Balance'
        default:
          $ref: '#/components/responses/StandardError'

  # === TRANSACTION READS ===
  /transactions:
    get:
      summary: Retrieve historical transactions
      operationId: getTransactions
      tags:
        - Transaction
      description: |
        Retrieves historical transactions, which is **Batch-Latent (Daily)**. The three date fields 
        (`transaction_date`, `value_date`, `posting_date`) are provided for financial reconciliation.
      security:
        - qBankAuth: [transactions.read]
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Transaction'
        default:
          $ref: '#/components/responses/StandardError'

  # === PAYMENT INITIATION & STATUS ===
  /payments/ach:
    post:
      summary: Initiate an ACH payment (Asynchronous)
      operationId: createACHPayment
      tags:
        - Payment
      description: |
        Submits an ACH payment request (high-volume file transfer). This is an **Asynchronous (15 minute batch)** process and **Requires Idempotency-Key**.
      parameters:
        - $ref: '#/components/parameters/Idempotency-Key'
      security:
        - qBankAuth: [payments.ach.write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ACHPaymentRequest'
      responses:
        '202':
          description: Payment accepted for processing (Asynchronous)
          headers:
            Location:
              description: URI to check the status of the created payment.
              schema:
                type: string
                format: uri
        '409':
          $ref: '#/components/responses/IdempotencyConflict'
        default:
          $ref: '#/components/responses/StandardError'

  /payments/wire:
    post:
      summary: Initiate a Wire payment (Real-Time)
      operationId: createWirePayment
      tags:
        - Payment
      description: |
        Submits a Wire payment request. This is a **Real-Time** operation and **Requires Idempotency-Key**.
      parameters:
        - $ref: '#/components/parameters/Idempotency-Key'
      security:
        - qBankAuth: [payments.wire.write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WirePaymentRequest'
      responses:
        '201':
          description: Wire payment successfully initiated (Real-Time)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '409':
          $ref: '#/components/responses/IdempotencyConflict'
        default:
          $ref: '#/components/responses/StandardError'

  /payments/{paymentId}:
    get:
      summary: Get the status of an initiated payment
      operationId: getPaymentStatus
      tags:
        - Payment
      description: |
        Retrieves the current status of any payment (ACH or Wire) using its unique ID.
        This allows the client to poll for the final outcome of asynchronous payments.
      parameters:
        - name: paymentId
          in: path
          description: The unique ID of the payment transaction.
          required: true
          schema:
            type: string
            format: uuid
      security:
        - qBankAuth: [payments.read]
      responses:
        '200':
          description: Successful response with payment details and status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        default:
          $ref: '#/components/responses/StandardError'

  /transfers:
    post:
      summary: Execute an internal fund transfer (Real-Time)
      operationId: createInternalTransfer
      tags:
        - Transfer
      description: |
        Initiates a transfer between internal accounts. This is a **Real-Time** operation and **Requires 
        Idempotency-Key** for transactional integrity.
      parameters:
        - $ref: '#/components/parameters/Idempotency-Key'
      security:
        - qBankAuth: [transfers.write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferRequest'
      responses:
        '201':
          description: Transfer successfully initiated (Real-Time)
        '409':
          $ref: '#/components/responses/IdempotencyConflict'
        default:
          $ref: '#/components/responses/StandardError'

  # === POSITIVE PAY (FRAUD PREVENTION) ===
  /positivepay/issues:
    post:
      summary: Submit a new check issue record
      operationId: createPositivePayIssue
      tags:
        - Positive Pay
      description: |
        Submit a new record of a check issued (sent) for Positive Pay fraud prevention.
        This is typically a **Batch** process and **Requires Idempotency-Key**.
      parameters:
        - $ref: '#/components/parameters/Idempotency-Key'
      security:
        - qBankAuth: [positivepay.issues.write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PositivePayIssueRequest'
      responses:
        '202':
          description: Issue record accepted for batch processing
        '409':
          $ref: '#/components/responses/IdempotencyConflict'
        default:
          $ref: '#/components/responses/StandardError'

  /positivepay/exceptions:
    get:
      summary: Retrieve outstanding Positive Pay exceptions
      operationId: getPositivePayExceptions
      tags:
        - Positive Pay
      description: |
        Retrieves a list of checks presented for payment that do not match an existing issue record (exceptions). 
        This is a **Batch** endpoint, typically synced daily.
      security:
        - qBankAuth: [positivepay.exceptions.read]
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PositivePayException'
        default:
          $ref: '#/components/responses/StandardError'

# === WEBHOOKS (INBOUND TO CLIENT) ===
webhooks:
  paymentStatusUpdate:
    description: |
      A notification sent to the client's registered callback URL when a significant state transition occurs 
      in a payment (e.g., from P_PROCESSING to P_COMPLETED or P_FAILED).
    post:
      summary: Payment Status Update Event
      requestBody:
        description: The payment status event payload.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEvent'
      # Headers expected to be received by the client's server
      parameters:
        - name: Webhook-Event-ID
          in: header
          description: An identifier for this webhook delivery attempt.
          schema:
            type: string
            format: uuid
        - name: Webhook-Signature
          in: header
          description: |
            The HMAC signature used to verify that the payload originated from QBank Connect and 
            has not been tampered with.
          schema:
            type: string
      responses:
        '200':
          description: Acknowledged receipt of the webhook event.

components:
  # === RESPONSES ===
  responses:
    StandardError:
      description: |
        Standard JSON error response for all non-conflict status codes (4xx and 5xx).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/StandardError'
    IdempotencyConflict:
      description: |
        Conflict (Idempotency Key Violation). Occurs when a duplicate request is received while the first is still processing.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

  # === SECURITY & SCOPES ===
  securitySchemes:
    qBankAuth:
      type: oauth2
      description: OAuth 2.0 Client Credentials Flow for B2B server-to-server authentication.
      flows:
        clientCredentials:
          tokenUrl: https://auth.qbankconnect.com/token
          scopes:
            accounts.read: Retrieve account general information
            balances.read: Retrieve real-time cash balances
            transactions.read: Retrieve historical transaction data
            payments.read: Retrieve payment status and history
            payments.ach.write: Initiate high volume ACH payments
            payments.wire.write: Initiate real-time Wire payments
            transfers.write: Execute internal fund transfers
            positivepay.issues.write: Submit check issue records
            positivepay.exceptions.read: Retrieve outstanding check exceptions

  # === PARAMETERS ===
  parameters:
    accountId:
      name: accountId
      in: path
      description: The unique identifier of the account.
      required: true
      schema:
        type: string
        format: uuid
        example: 0524c965-0679-4d89-9b48-d3269b8b7894
    Idempotency-Key:
      name: Idempotency-Key
      in: header
      description: |
        A unique 36-character key (UUID V4) required for all transactional requests (POST, PUT) 
        to prevent duplicate submissions.
      required: true
      schema:
        type: string
        format: uuid
        example: f47ac10b-58cc-4372-a567-0e02b2c3d479

  # === REUSABLE SCHEMAS ===
  schemas:
    AuditFields:
      type: object
      description: Mandatory fields for SOX/PCI compliance audit trails.
      properties:
        timestamp:
          type: string
          format: date-time
          description: Time recorded in UTC with millisecond accuracy.
          example: 2025-12-09T14:30:00.123Z
        actor:
          type: string
          description: The authenticated Client ID or User Identity who initiated the call.
          example: client_12345
        request_id:
          type: string
          format: uuid
          description: Unique request ID for end-to-end tracing purposes.
          example: 6a2c0f9e-3d8b-4c1e-b7a4-9e0f3d6c1b5a

    TokenRequest:
      type: object
      description: The form data required to request an OAuth 2.0 token.
      properties:
        grant_type:
          type: string
          enum: [client_credentials]
          default: client_credentials
        client_id:
          type: string
          description: Your unique client identifier.
        client_secret:
          type: string
          description: Your safe client secret.
        scope:
          type: string
          description: A space-separated list of permissions requested.

    TokenResponse:
      type: object
      description: The response body from a successful OAuth 2.0 token request.
      properties:
        access_token:
          type: string
          description: The Bearer Token to be used in the Authorization header.
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: The time in seconds the token remains valid.
        scope:
          type: string
          description: The scope of permissions granted for this token.

    Account:
      allOf:
        - $ref: '#/components/schemas/AuditFields'
        - type: object
          properties:
            accountId:
              type: string
              format: uuid
              description: The unique ID for the account.
            accountName:
              type: string
            accountType:
              type: string
              enum: [Checking, Savings, Treasury]

    Balance:
      type: object
      properties:
        accountId:
          type: string
          format: uuid
        availableBalance:
          type: number
          format: float
          description: The current amount of funds available for immediate use.
        currentBalance:
          type: number
          format: float
          description: The ledger balance.
        currency:
          type: string
          example: USD
          
    Transaction:
      allOf:
        - $ref: '#/components/schemas/AuditFields'
        - type: object
          description: A record of a financial transaction, including all three date fields for reconciliation.
          properties:
            transactionId:
              type: string
              format: uuid
            amount:
              type: number
              format: float
            description:
              type: string
            transaction_date:
              type: string
              format: date-time
              description: The date and time when the customer/ERP initiated the transaction.
            value_date:
              type: string
              format: date
              description: The date upon which funds are actually credited/debited (for interest).
            posting_date:
              type: string
              format: date-time
              description: The date and time the transaction record was made available via API (EOD sync).
    
    ACHPaymentRequest:
      type: object
      description: The payload for initiating an ACH payment.
      required: [source_account_id, destination_account_id, amount]
      properties:
        source_account_id:
          type: string
          format: uuid
        destination_account_id:
          type: string
          format: uuid
        amount:
          type: number
          format: float
          description: The amount to be transferred.
        reference_id:
          type: string
          description: An optional field for external system reference.

    WirePaymentRequest:
      type: object
      description: The payload for initiating a Wire payment.
      required: [source_account_id, beneficiary_details, amount, reference_code]
      properties:
        source_account_id:
          type: string
          format: uuid
        beneficiary_details:
          type: object
          properties:
            name:
              type: string
            bank_id:
              type: string
              description: ABA/Routing number.
            account_number:
              type: string
        amount:
          type: number
          format: float
        reference_code:
          type: string
          description: Mandatory reference for the wire transfer.

    Payment:
      allOf:
        - $ref: '#/components/schemas/AuditFields'
        - type: object
          description: Common structure for all payment resources (ACH and Wire).
          properties:
            paymentId:
              type: string
              format: uuid
            type:
              type: string
              enum: [ACH, WIRE]
            amount:
              type: number
              format: float
            status:
              type: string
              description: The current lifecycle state of the payment (e.g., P_PROCESSING, P_COMPLETED, P_FAILED).
              enum: [P_PROCESSING, P_COMPLETED, P_FAILED]
              example: P_PROCESSING
            creationDate:
              type: string
              format: date-time
            completionDate:
              type: string
              format: date-time
              nullable: true

    TransferRequest:
      type: object
      description: The payload for an internal account transfer.
      required: [from_account_id, to_account_id, amount]
      properties:
        from_account_id:
          type: string
          format: uuid
        to_account_id:
          type: string
          format: uuid
        amount:
          type: number
          format: float

    PositivePayIssueRequest:
      type: object
      description: Record of a check issued (sent) for Positive Pay matching.
      required: [issue_id, account_id, check_number, amount, issue_date]
      properties:
        issue_id:
          type: string
          format: uuid
        account_id:
          type: string
          format: uuid
        check_number:
          type: string
          description: The sequential check number.
        amount:
          type: number
          format: float
        issue_date:
          type: string
          format: date
          description: Date the check was physically issued.

    PositivePayException:
      allOf:
        - $ref: '#/components/schemas/AuditFields'
        - type: object
          description: A check presented for payment that does not match an issued record.
          properties:
            exceptionId:
              type: string
              format: uuid
            account_id:
              type: string
              format: uuid
            check_number:
              type: string
            presented_amount:
              type: number
              format: float
            presentment_date:
              type: string
              format: date
            reason_code:
              type: string
              description: Code indicating why it's an exception (e.g., AMOUNT_MISMATCH, NO_ISSUE).

    WebhookEvent:
      type: object
      description: The payload structure for an outbound webhook notification.
      properties:
        event_id:
          type: string
          format: uuid
        event_type:
          type: string
          enum: [payment.status.update]
        resource_type:
          type: string
          enum: [payment]
        data:
          description: The full updated resource object.
          $ref: '#/components/schemas/Payment'

    StandardError:
      type: object
      description: Standard JSON error response.
      properties:
        message:
          type: string
          description: User friendly description of the problem encountered.
        error_code:
          type: string
          description: QBank specific code for automatic programmatic handling.
        request_id:
          type: string
          format: uuid
          description: A unique identifier for end-to-end tracing.
      example:
        message: 'The requested account was not found.'
        error_code: 'ERR_ACC_001'
        request_id: 'a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890'

    ProblemDetails:
      type: object
      description: Standard application/problem+json structure for 409 Conflict.
      properties:
        type:
          type: string
          format: uri
          example: https://api.qbankconnect.com/problems/idempotency-conflict
        title:
          type: string
          example: Idempotency Key Conflict
        status:
          type: integer
          example: 409
        detail:
          type: string
          description: Human-readable explanation specific to this occurrence.
          example: A request with the same Idempotency-Key is already processing.
        transaction_id:
          type: string
          format: uuid
          description: The ID of the transaction already processing.